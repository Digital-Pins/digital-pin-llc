# Nginx server block for dev-erp.digitalpin.online (Development Dolibarr instance)
# Usage:
#   Place at /etc/nginx/sites-available/dev-erp.digitalpin.conf then symlink to sites-enabled.
#   Provides isolated dev sandbox so production erp.digitalpin.online remains unchanged.

server {
    listen 80;
    listen [::]:80;
    server_name dev-erp.digitalpin.online;
    # ACME challenge (HTTP-01)
    location /.well-known/acme-challenge/ { root /var/www/certbot; }
    # Redirect everything else to HTTPS once cert is issued
    location / { return 301 https://$host$request_uri; }
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name dev-erp.digitalpin.online;

    # Letâ€™s Encrypt live paths (issue cert first with certbot)
    ssl_certificate /etc/letsencrypt/live/dev-erp.digitalpin.online/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dev-erp.digitalpin.online/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers off;

    # Dev instance: use dev-specific security headers include (shorter HSTS) + SAMEORIGIN frame policy
    add_header X-Frame-Options SAMEORIGIN;
    include /home/pin2/digital-pin-llc/digital-pin-llc/scripts/deploy/nginx-security-headers-dev.conf;

    # Root points to dedicated dev deployment path
    root /opt/dolibarr-dev/htdocs;
    index index.php index.html;
    client_max_body_size 32M;

    # Primary routing: static else front controller
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # Static assets caching
    location ~* \.(?:css|js|svg|png|jpg|jpeg|gif|ico|webp)$ {
        try_files $uri =404;
        access_log off;
        expires 7d;
    }

    # PHP handling (adjust socket version if needed)
    location ~ \.php$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $request_filename;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
        fastcgi_read_timeout 150s;
    }

    # Block direct sensitive dirs
    location ~ /(doc|documents|conf|includes|scripts)/ { deny all; }

    # Optional Basic Auth for dev (uncomment to enable)
    # auth_basic "Dev ERP";
    # auth_basic_user_file /etc/nginx/.htpasswd_dev_erp;

    access_log /var/log/nginx/dev_erp.access.log;
    error_log  /var/log/nginx/dev_erp.error.log warn;
}
